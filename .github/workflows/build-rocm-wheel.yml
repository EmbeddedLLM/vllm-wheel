name: Build ROCm Wheels and Publish to PyPI
on:
  workflow_dispatch:
    inputs:
      pytorch_rocm_arch:
        description: 'ROCm GPU architectures (semicolon-separated)'
        required: false
        default: 'gfx942'
      python_version:
        description: 'Python version'
        required: false
        default: '3.12'
      rocm_version:
        description: 'ROCm version'
        required: false
        default: '7.1'
      vllm_version:
        description: 'vLLM version (tag like v0.11.2 or branch like main, or "latest" for auto-fetch)'
        required: false
        default: 'latest'
      debug_mode:
        description: 'Debug mode: skip Jobs 1&2, reuse artifacts from previous run'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_to_job4:
        description: 'Skip to Job 4 only: skip all builds, only publish (requires previous_run_id)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      previous_run_id:
        description: 'Run ID to reuse artifacts from (required if debug_mode or skip_to_job4 is true)'
        required: false
        default: ''
      upload_wheels:
        description: 'Upload wheels to S3 (false for nightly builds, true for releases)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build-base-wheels:
    name: Build ROCm Base Wheels
    if: github.event.inputs.debug_mode != 'true' && github.event.inputs.skip_to_job4 != 'true'
    runs-on:
      labels: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for correct version detection
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build ROCm base image (full)
        run: |
          docker buildx build \
            --file docker/Dockerfile.rocm_base \
            --tag rocm/vllm-dev:base \
            --build-arg PYTORCH_ROCM_ARCH="${{ github.event.inputs.pytorch_rocm_arch }}" \
            --build-arg PYTHON_VERSION="${{ github.event.inputs.python_version }}" \
            --load \
            .
      - name: Build debs stage for wheel extraction
        run: |
          docker buildx build \
            --file docker/Dockerfile.rocm_base \
            --tag rocm-base-debs:local \
            --target debs \
            --build-arg PYTORCH_ROCM_ARCH="${{ github.event.inputs.pytorch_rocm_arch }}" \
            --build-arg PYTHON_VERSION="${{ github.event.inputs.python_version }}" \
            --load \
            .
      - name: Extract wheels from Docker image
        run: |
          mkdir -p artifacts/base-wheels
          container_id=$(docker create rocm-base-debs:local)
          docker cp ${container_id}:/app/debs/. artifacts/base-wheels/
          docker rm ${container_id}
          ls -lh artifacts/base-wheels/
      - name: Export base Docker image for reuse
        run: |
          mkdir -p artifacts/docker-image
          docker save rocm/vllm-dev:base | gzip > artifacts/docker-image/rocm-base-image.tar.gz
          ls -lh artifacts/docker-image/
      - name: Upload base wheels
        uses: actions/upload-artifact@v4
        with:
          name: rocm-base-wheels
          path: artifacts/base-wheels/*.whl
          retention-days: 7
      - name: Upload base Docker image
        uses: actions/upload-artifact@v4
        with:
          name: rocm-base-image
          path: artifacts/docker-image/rocm-base-image.tar.gz
          retention-days: 7

  build-vllm-wheel:
    name: Build vLLM ROCm Wheel
    needs: build-base-wheels
    if: always() && github.event.inputs.skip_to_job4 != 'true' && (needs.build-base-wheels.result == 'success' || github.event.inputs.debug_mode == 'true')
    runs-on:
      labels: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for correct version detection

      - name: Download base Docker image (normal mode)
        if: github.event.inputs.debug_mode != 'true'
        uses: actions/download-artifact@v4
        with:
          name: rocm-base-image
          path: artifacts/docker-image

      - name: Download base Docker image (debug mode - from previous run)
        if: github.event.inputs.debug_mode == 'true'
        uses: actions/download-artifact@v4
        with:
          name: rocm-base-image
          path: artifacts/docker-image
          run-id: ${{ github.event.inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Load base Docker image
        run: |
          gunzip -c artifacts/docker-image/rocm-base-image.tar.gz | docker load
          docker images rocm/vllm-dev:base

      - name: Download base wheels (normal mode)
        if: github.event.inputs.debug_mode != 'true'
        uses: actions/download-artifact@v4
        with:
          name: rocm-base-wheels
          path: artifacts/base-wheels

      - name: Download base wheels (debug mode - from previous run)
        if: github.event.inputs.debug_mode == 'true'
        uses: actions/download-artifact@v4
        with:
          name: rocm-base-wheels
          path: artifacts/base-wheels
          run-id: ${{ github.event.inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify base wheels downloaded
        run: |
          echo "Base wheels downloaded:"
          ls -lh artifacts/base-wheels/
          echo "Total wheels: $(ls artifacts/base-wheels/*.whl 2>/dev/null | wc -l)"

      - name: Get vLLM version
        id: vllm_version
        run: |
          INPUT_VERSION="${{ github.event.inputs.vllm_version }}"

          if [ "$INPUT_VERSION" = "latest" ] || [ -z "$INPUT_VERSION" ]; then
            echo "Fetching latest vLLM release from GitHub API..."
            VLLM_VERSION=$(curl -s https://api.github.com/repos/vllm-project/vllm/releases/latest | jq -r .tag_name)

            if [ "$VLLM_VERSION" = "null" ] || [ -z "$VLLM_VERSION" ]; then
              echo "ERROR: Could not fetch latest release tag"
              echo "Falling back to main branch"
              VLLM_VERSION="main"
            fi
          else
            echo "Using specified version: $INPUT_VERSION"
            VLLM_VERSION="$INPUT_VERSION"
          fi

          echo "vLLM version to build: $VLLM_VERSION"
          echo "tag=$VLLM_VERSION" >> $GITHUB_OUTPUT
      - name: Build and extract vLLM wheel using Dockerfile.rocm
        run: |
          echo "Building vLLM wheel from official release: ${{ steps.vllm_version.outputs.tag }}"
          DOCKER_BUILDKIT=1 docker build \
            --file docker/Dockerfile.rocm \
            --target export_vllm \
            --output type=local,dest=dist \
            --build-arg BASE_IMAGE=rocm/vllm-dev:base \
            --build-arg ARG_PYTORCH_ROCM_ARCH="${{ github.event.inputs.pytorch_rocm_arch }}" \
            --build-arg REMOTE_VLLM=1 \
            --build-arg VLLM_REPO=https://github.com/vllm-project/vllm.git \
            --build-arg VLLM_BRANCH="${{ steps.vllm_version.outputs.tag }}" \
            .
          ls -lh dist/
          ls -lh dist/*.whl

          echo ""
          echo "Extracted dependency wheels:"
          ls -lh dist/dependency-wheels/
          echo "Total dependency wheels: $(ls dist/dependency-wheels/*.whl 2>/dev/null | wc -l)"

          echo ""
          echo "Dependency list:"
          cat dist/all-dependencies.txt

      - name: Install auditwheel and repair wheel
        run: |
          python -m pip install auditwheel patchelf
          mkdir -p artifacts/vllm-wheel
          for wheel in dist/*.whl; do
            echo "Repairing wheel: $wheel"
            auditwheel repair --plat manylinux_2_28_x86_64 -w artifacts/vllm-wheel/ "$wheel" || \
            cp "$wheel" artifacts/vllm-wheel/
          done
          ls -lh artifacts/vllm-wheel/
      - name: Upload vLLM wheel
        uses: actions/upload-artifact@v4
        with:
          name: vllm-wheel
          path: artifacts/vllm-wheel/*.whl
          retention-days: 7

      - name: Upload dependency wheels
        uses: actions/upload-artifact@v4
        with:
          name: dependency-wheels
          path: dist/dependency-wheels/*.whl
          retention-days: 7

  create-pypi-repository:
    name: Create PyPI Repository and Publish
    needs: [build-base-wheels, build-vllm-wheel]
    if: github.event.inputs.upload_wheels == 'true' && always() && (needs.build-vllm-wheel.result == 'success' || github.event.inputs.skip_to_job4 == 'true')
    runs-on: ubuntu-latest-l
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for correct version detection

      - name: Download all artifacts (normal mode)
        if: github.event.inputs.debug_mode != 'true' && github.event.inputs.skip_to_job4 != 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Download all artifacts (debug mode - from previous run + current)
        if: github.event.inputs.debug_mode == 'true' && github.event.inputs.skip_to_job4 != 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          run-id: ${{ github.event.inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download vLLM wheel from current run (debug mode)
        if: github.event.inputs.debug_mode == 'true' && github.event.inputs.skip_to_job4 != 'true'
        uses: actions/download-artifact@v4
        with:
          name: vllm-wheel
          path: artifacts/vllm-wheel

      - name: Download dependency wheels from current run (debug mode)
        if: github.event.inputs.debug_mode == 'true' && github.event.inputs.skip_to_job4 != 'true'
        uses: actions/download-artifact@v4
        with:
          name: dependency-wheels
          path: artifacts/dependency-wheels

      - name: Download all artifacts (skip to job 4 mode - from previous run only)
        if: github.event.inputs.skip_to_job4 == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          run-id: ${{ github.event.inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version }}
      - name: Install dependencies
        run: |
          pip install awscli packaging

      - name: Debug artifacts structure
        run: |
          echo "Current directory: $(pwd)"
          echo ""
          echo "Contents of current directory:"
          ls -la
          echo ""
          echo "Checking for artifacts directory:"
          if [ -d "artifacts" ]; then
            echo "âœ“ artifacts/ directory exists"
            echo ""
            echo "Contents of artifacts/:"
            ls -laR artifacts/
            echo ""
            echo "Searching for wheel files..."
            find artifacts -name "*.whl" -type f
            echo ""
            WHEEL_COUNT=$(find artifacts -name "*.whl" -type f | wc -l)
            echo "Total wheels found: $WHEEL_COUNT"
            if [ "$WHEEL_COUNT" -eq 0 ]; then
              echo "ERROR: No wheels found in artifacts directory!"
              exit 1
            fi
          else
            echo "âœ— ERROR: artifacts/ directory NOT FOUND!"
            echo "This will cause organize_wheels.py to fail!"
            exit 1
          fi
          echo ""
          echo "GITHUB_OUTPUT is set to: ${GITHUB_OUTPUT}"
          if [ -z "$GITHUB_OUTPUT" ]; then
            echo "ERROR: GITHUB_OUTPUT is not set!"
            exit 1
          fi

      - name: Collect all wheels into single directory
        id: collect_wheels
        timeout-minutes: 30
        run: |
          echo "Collecting all wheels into single directory for S3 upload..."
          mkdir -p all-wheels

          # Find and copy all wheels from artifacts
          find artifacts -name "*.whl" -type f -exec cp {} all-wheels/ \;

          WHEEL_COUNT=$(ls all-wheels/*.whl 2>/dev/null | wc -l)
          echo "Total wheels collected: $WHEEL_COUNT"

          if [ "$WHEEL_COUNT" -eq 0 ]; then
            echo "ERROR: No wheels found!"
            exit 1
          fi

          # List some sample wheels
          echo ""
          echo "Sample wheels:"
          ls -lh all-wheels/ | head -20

          echo ""
          echo "Total size:"
          du -sh all-wheels/

      - name: Debug - Show artifacts structure
        run: |
          echo "========================================="
          echo "Debugging: Artifacts Directory Structure"
          echo "========================================="
          echo ""

          echo "Contents of artifacts/:"
          ls -la artifacts/ || echo "ERROR: artifacts/ not found!"
          echo ""

          echo "Checking for rocm-base-wheels artifact:"
          if [ -d "artifacts/rocm-base-wheels" ]; then
            echo "âœ“ artifacts/rocm-base-wheels/ EXISTS"
            echo ""
            echo "Contents:"
            ls -lh artifacts/rocm-base-wheels/
            echo ""
            echo "Wheel count: $(ls artifacts/rocm-base-wheels/*.whl 2>/dev/null | wc -l)"
            echo ""
            echo "Wheel names:"
            ls artifacts/rocm-base-wheels/*.whl 2>/dev/null || echo "No .whl files found!"
          else
            echo "âœ— ERROR: artifacts/rocm-base-wheels/ NOT FOUND!"
            echo ""
            echo "Available directories in artifacts/:"
            find artifacts/ -type d -maxdepth 2
          fi
          echo ""
          echo "========================================="

      - name: Remove PyPI duplicates of custom ROCm packages
        run: |
          chmod +x tools/vllm-rocm/cleanup_pypi_duplicates.sh
          tools/vllm-rocm/cleanup_pypi_duplicates.sh artifacts/rocm-base-wheels all-wheels

      - name: Generate PyPI index for S3
        run: |
          echo "Generating PyPI index for S3..."

          # Set S3 URL (website endpoint for directory index support)
          S3_URL="http://${{ secrets.AWS_S3_BUCKET }}.s3-website-${{ secrets.AWS_REGION }}.amazonaws.com"

          echo "S3 URL: $S3_URL"

          # Generate index using our script
          python3 tools/vllm-rocm/generate_s3_index.py \
            --wheels-dir all-wheels \
            --output-dir pypi-index \
            --s3-url "$S3_URL" \
            --rocm-version "${{ github.event.inputs.rocm_version }}" \
            --python-version "${{ github.event.inputs.python_version }}" \
            --gpu-arch "${{ github.event.inputs.pytorch_rocm_arch }}" \
            --vllm-version "${{ github.event.inputs.vllm_version }}" \
            --no-metadata

          echo ""
          echo "Index structure:"
          tree -L 2 pypi-index/ || find pypi-index/ -type d

      - name: Configure AWS credentials
        run: |
          echo "Configuring AWS credentials..."
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set default.region "${{ secrets.AWS_REGION }}"
          echo "âœ… AWS configured"

      - name: Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          bash tools/vllm-rocm/upload_to_s3.sh \
            all-wheels \
            pypi-index \
            "${{ secrets.AWS_S3_BUCKET }}" \
            "${{ secrets.AWS_REGION }}"

      - name: Summary
        run: |
          S3_URL="http://${{ secrets.AWS_S3_BUCKET }}.s3-website-${{ secrets.AWS_REGION }}.amazonaws.com"
          WHEEL_COUNT=$(ls all-wheels/*.whl 2>/dev/null | wc -l)

          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… vLLM ROCm wheels published successfully to S3!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ‰ Ready to Use!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Command" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install vllm --index-url ${S3_URL}/simple/" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or install all packages explicitly:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install torch triton torchvision vllm --index-url ${S3_URL}/simple/" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **ROCm Version**: ${{ github.event.inputs.rocm_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version**: ${{ github.event.inputs.python_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GPU Architectures**: ${{ github.event.inputs.pytorch_rocm_arch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **vLLM Version**: ${{ github.event.inputs.vllm_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Wheels**: $WHEEL_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository Home**: ${S3_URL}/" >> $GITHUB_STEP_SUMMARY
          echo "- **PyPI Index**: ${S3_URL}/simple/" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: ${{ secrets.AWS_S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¾ Storage" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage**: AWS S3" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ secrets.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **All wheels hosted on S3** (no size limits, better performance)" >> $GITHUB_STEP_SUMMARY