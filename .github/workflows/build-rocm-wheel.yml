name: Build ROCm Wheels and Publish to PyPI
on:
  workflow_dispatch:
    inputs:
      pytorch_rocm_arch:
        description: 'ROCm GPU architectures (semicolon-separated)'
        required: false
        default: 'gfx942'
      python_version:
        description: 'Python version'
        required: false
        default: '3.12'
      rocm_version:
        description: 'ROCm version'
        required: false
        default: '7.1'
      debug_mode:
        description: 'Debug mode: skip Jobs 1&2, reuse artifacts from previous run'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_to_job4:
        description: 'Skip to Job 4 only: skip all builds, only publish (requires previous_run_id)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      previous_run_id:
        description: 'Run ID to reuse artifacts from (required if debug_mode or skip_to_job4 is true)'
        required: false
        default: ''
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build-base-wheels:
    name: Build ROCm Base Wheels
    if: github.event.inputs.debug_mode != 'true' && github.event.inputs.skip_to_job4 != 'true'
    runs-on:
      labels: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for correct version detection
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build ROCm base image (full)
        run: |
          docker buildx build \
            --file docker/Dockerfile.rocm_base.minimal \
            --tag rocm/vllm-dev:base \
            --build-arg PYTORCH_ROCM_ARCH=${{ github.event.inputs.pytorch_rocm_arch }} \
            --build-arg PYTHON_VERSION=${{ github.event.inputs.python_version }} \
            --load \
            .
      - name: Build debs stage for wheel extraction
        run: |
          docker buildx build \
            --file docker/Dockerfile.rocm_base.minimal \
            --tag rocm-base-debs:local \
            --target debs \
            --build-arg PYTORCH_ROCM_ARCH=${{ github.event.inputs.pytorch_rocm_arch }} \
            --build-arg PYTHON_VERSION=${{ github.event.inputs.python_version }} \
            --load \
            .
      - name: Extract wheels from Docker image
        run: |
          mkdir -p artifacts/base-wheels
          container_id=$(docker create rocm-base-debs:local)
          docker cp ${container_id}:/app/debs/. artifacts/base-wheels/
          docker rm ${container_id}
          ls -lh artifacts/base-wheels/
      - name: Export base Docker image for reuse
        run: |
          mkdir -p artifacts/docker-image
          docker save rocm/vllm-dev:base | gzip > artifacts/docker-image/rocm-base-image.tar.gz
          ls -lh artifacts/docker-image/
      - name: Upload base wheels
        uses: actions/upload-artifact@v4
        with:
          name: rocm-base-wheels
          path: artifacts/base-wheels/*.whl
          retention-days: 7
      - name: Upload base Docker image
        uses: actions/upload-artifact@v4
        with:
          name: rocm-base-image
          path: artifacts/docker-image/rocm-base-image.tar.gz
          retention-days: 7
  collect-dependency-wheels:
    name: Collect Dependency Wheels from PyPI
    if: github.event.inputs.debug_mode != 'true' && github.event.inputs.skip_to_job4 != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for correct version detection
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version }}
      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools packaging requests
      - name: Download dependency wheels with version ranges
        run: |
          python .github/scripts/download_dependency_wheels.py \
            --requirements requirements/rocm.txt \
            --output-dir artifacts/dependency-wheels \
            --python-version ${{ github.event.inputs.python_version }} \
            --max-versions 5
      - name: List downloaded wheels
        run: |
          echo "Downloaded wheels:"
          ls -lh artifacts/dependency-wheels/
          echo "Total size:"
          du -sh artifacts/dependency-wheels/
          echo "Total count: $(ls artifacts/dependency-wheels/*.whl 2>/dev/null | wc -l) wheels"

      - name: Validate critical dependencies
        run: |
          WHEEL_COUNT=$(ls artifacts/dependency-wheels/*.whl 2>/dev/null | wc -l)
          echo "Downloaded $WHEEL_COUNT wheels"

          # With transitive dependencies, we should have 150+ wheels
          if [ "$WHEEL_COUNT" -lt 150 ]; then
            echo "::error::Too few wheels downloaded ($WHEEL_COUNT). Expected at least 150 (including transitive dependencies)."
            echo "::error::Check the download logs above for failures."
            exit 1
          fi

          # Check for specific critical packages (including transitive deps)
          CRITICAL_PKGS="regex numpy transformers tokenizers protobuf pydantic aiohttp requests tqdm fastapi anyio"
          MISSING=""

          for pkg in $CRITICAL_PKGS; do
            if ! ls artifacts/dependency-wheels/${pkg}-*.whl 2>/dev/null | grep -q .; then
              MISSING="$MISSING $pkg"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo "::error::Missing critical packages:$MISSING"
            echo "::error::These packages are required for vllm to function properly."
            exit 1
          fi

          echo "âœ… All critical packages present!"

      - name: Upload dependency wheels
        uses: actions/upload-artifact@v4
        with:
          name: dependency-wheels
          path: artifacts/dependency-wheels/*.whl
          retention-days: 7
  build-vllm-wheel:
    name: Build vLLM ROCm Wheel
    needs: build-base-wheels
    if: always() && github.event.inputs.skip_to_job4 != 'true' && (needs.build-base-wheels.result == 'success' || github.event.inputs.debug_mode == 'true')
    runs-on:
      labels: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for correct version detection

      - name: Download base Docker image (normal mode)
        if: github.event.inputs.debug_mode != 'true'
        uses: actions/download-artifact@v4
        with:
          name: rocm-base-image
          path: artifacts/docker-image

      - name: Download base Docker image (debug mode - from previous run)
        if: github.event.inputs.debug_mode == 'true'
        uses: actions/download-artifact@v4
        with:
          name: rocm-base-image
          path: artifacts/docker-image
          run-id: ${{ github.event.inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Load base Docker image
        run: |
          gunzip -c artifacts/docker-image/rocm-base-image.tar.gz | docker load
          docker images rocm/vllm-dev:base
      - name: Build and extract vLLM wheel using Dockerfile.rocm
        run: |
          DOCKER_BUILDKIT=1 docker build \
            --file docker/Dockerfile.rocm \
            --target export_vllm \
            --output type=local,dest=dist \
            --build-arg BASE_IMAGE=rocm/vllm-dev:base \
            --build-arg ARG_PYTORCH_ROCM_ARCH=${{ github.event.inputs.pytorch_rocm_arch }} \
            --build-arg REMOTE_VLLM=0 \
            .
          ls -lh dist/
          ls -lh dist/*.whl
      - name: Install auditwheel and repair wheel
        run: |
          python -m pip install auditwheel patchelf
          mkdir -p artifacts/vllm-wheel
          for wheel in dist/*.whl; do
            echo "Repairing wheel: $wheel"
            auditwheel repair --plat manylinux_2_28_x86_64 -w artifacts/vllm-wheel/ "$wheel" || \
            cp "$wheel" artifacts/vllm-wheel/
          done
          ls -lh artifacts/vllm-wheel/
      - name: Upload vLLM wheel
        uses: actions/upload-artifact@v4
        with:
          name: vllm-wheel
          path: artifacts/vllm-wheel/*.whl
          retention-days: 7
  create-pypi-repository:
    name: Create PyPI Repository and Publish
    needs: [build-base-wheels, collect-dependency-wheels, build-vllm-wheel]
    if: always() && (needs.build-vllm-wheel.result == 'success' || github.event.inputs.skip_to_job4 == 'true') && (github.event.inputs.debug_mode != 'true' || github.event.inputs.skip_to_job4 == 'true' || (needs.build-base-wheels.result == 'skipped' && needs.collect-dependency-wheels.result == 'skipped'))
    runs-on:
      labels: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for correct version detection

      - name: Download all artifacts (normal mode)
        if: github.event.inputs.debug_mode != 'true' && github.event.inputs.skip_to_job4 != 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Download all artifacts (debug mode - from previous run + current)
        if: github.event.inputs.debug_mode == 'true' && github.event.inputs.skip_to_job4 != 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          run-id: ${{ github.event.inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download vLLM wheel from current run (debug mode)
        if: github.event.inputs.debug_mode == 'true' && github.event.inputs.skip_to_job4 != 'true'
        uses: actions/download-artifact@v4
        with:
          name: vllm-wheel
          path: artifacts/vllm-wheel

      - name: Download all artifacts (skip to job 4 mode - from previous run only)
        if: github.event.inputs.skip_to_job4 == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          run-id: ${{ github.event.inputs.previous_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version }}
      - name: Install dumb-pypi
        run: |
          pip install dumb-pypi

      - name: Debug artifacts structure
        run: |
          echo "Current directory: $(pwd)"
          echo ""
          echo "Contents of current directory:"
          ls -la
          echo ""
          echo "Checking for artifacts directory:"
          if [ -d "artifacts" ]; then
            echo "âœ“ artifacts/ directory exists"
            echo ""
            echo "Contents of artifacts/:"
            ls -laR artifacts/
            echo ""
            echo "Searching for wheel files..."
            find artifacts -name "*.whl" -type f
            echo ""
            WHEEL_COUNT=$(find artifacts -name "*.whl" -type f | wc -l)
            echo "Total wheels found: $WHEEL_COUNT"
            if [ "$WHEEL_COUNT" -eq 0 ]; then
              echo "ERROR: No wheels found in artifacts directory!"
              exit 1
            fi
          else
            echo "âœ— ERROR: artifacts/ directory NOT FOUND!"
            echo "This will cause organize_wheels.py to fail!"
            exit 1
          fi
          echo ""
          echo "GITHUB_OUTPUT is set to: ${GITHUB_OUTPUT}"
          if [ -z "$GITHUB_OUTPUT" ]; then
            echo "ERROR: GITHUB_OUTPUT is not set!"
            exit 1
          fi

      - name: Organize and separate wheels by size
        id: separate_wheels
        timeout-minutes: 30
        run: python3 .github/scripts/organize_wheels.py

      - name: Create GitHub Release for large wheels
        if: hashFiles('pypi-repo/packages-large/*.whl') != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ steps.separate_wheels.outputs.release_tag }}"

          # Create release
          gh release create "$RELEASE_TAG" \
            --repo ${{ github.repository }} \
            --title "ROCm Wheels - $(date +%Y-%m-%d)" \
            --notes "Large ML framework wheels for vLLM ROCm

          ## Included Wheels
          $(ls -1 pypi-repo/packages-large/)

          ## Build Info
          - ROCm Version: ${{ github.event.inputs.rocm_version }}
          - Python Version: ${{ github.event.inputs.python_version }}
          - GPU Architectures: ${{ github.event.inputs.pytorch_rocm_arch }}
          - Commit: ${{ github.sha }}

          ## Installation
          These wheels are automatically referenced by the PyPI index at:
          https://${{ github.repository_owner }}.github.io/vllm-rocm/simple/

          Use: \`pip install vllm-rocm --index-url https://${{ github.repository_owner }}.github.io/vllm-rocm/simple/\`"

          # Upload large wheels to release
          gh release upload "$RELEASE_TAG" pypi-repo/packages-large/*.whl \
            --repo ${{ github.repository }} \
            --clobber

      - name: Generate custom PyPI index with mixed URLs
        run: |
          cd pypi-repo

          PAGES_URL="https://${{ github.repository_owner }}.github.io/vllm-rocm"
          RELEASE_TAG="${{ steps.separate_wheels.outputs.release_tag }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}"

          # Create simple directory structure
          mkdir -p simple

          # Generate index for each package
          for wheel in packages-small/*.whl packages-large/*.whl; do
            [ -f "$wheel" ] || continue

            # Extract package name (convert underscores/hyphens to lowercase, remove version)
            wheel_name=$(basename "$wheel")
            pkg_name=$(echo "$wheel_name" | sed -E 's/(-|_)[0-9].*//' | tr '[:upper:]' '[:lower:]' | tr '_' '-')

            mkdir -p "simple/$pkg_name"

            # Determine URL based on size
            if [ -f "packages-large/$(basename $wheel)" ]; then
              wheel_url="$RELEASE_URL/$(basename $wheel)"
            else
              wheel_url="$PAGES_URL/packages/$(basename $wheel)"
            fi

            # Create/append to package index
            echo "<a href=\"$wheel_url\">$(basename $wheel)</a><br/>" >> "simple/$pkg_name/index.html"
          done

          # Create main simple index
          cat > simple/index.html << 'EOF'
          <!DOCTYPE html>
          <html><head><title>Simple Index</title></head><body>
          EOF

          for pkg_dir in simple/*/; do
            [ -d "$pkg_dir" ] || continue
            pkg_name=$(basename "$pkg_dir")
            echo "<a href=\"$pkg_name/\">$pkg_name</a><br/>" >> simple/index.html
          done

          echo "</body></html>" >> simple/index.html

          # Move small wheels to packages directory for Pages
          rm -rf packages
          mv packages-small packages
          rm -rf packages-large

          echo "âœ… PyPI index structure created"
          tree -L 2 || find . -type d
      - name: Create landing page
        run: |
          cd pypi-repo
          PAGES_URL="https://${{ github.repository_owner }}.github.io/vllm-rocm"
          RELEASE_TAG="${{ steps.separate_wheels.outputs.release_tag }}"
          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>vLLM ROCm PyPI Repository</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
                  code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
                  pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
                  .info { background: #e7f3ff; padding: 10px; border-left: 4px solid #2196F3; margin: 15px 0; }
              </style>
          </head>
          <body>
              <h1>vLLM ROCm PyPI Repository</h1>
              <p>This is a custom PyPI repository for vLLM with ROCm support and all dependencies.</p>
              <div class="info">
                  <strong>ðŸ“¦ Hybrid Storage:</strong> Small wheels (&lt;100MB) are hosted on GitHub Pages,
                  while large wheels (PyTorch, Triton) are hosted on GitHub Releases for better performance.
              </div>
              <h2>Installation</h2>
              <pre><code>pip install vllm-rocm --index-url ${PAGES_URL}/simple/</code></pre>
              <h2>Available Packages</h2>
              <p><a href="simple/">Browse packages</a></p>
              <h2>Build Information</h2>
              <ul>
                  <li>ROCm Version: ${{ github.event.inputs.rocm_version }}</li>
                  <li>Python Version: ${{ github.event.inputs.python_version }}</li>
                  <li>GPU Architectures: ${{ github.event.inputs.pytorch_rocm_arch }}</li>
                  <li>Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</li>
                  <li>Commit: ${{ github.sha }}</li>
                  <li>Release Tag: ${RELEASE_TAG}</li>
              </ul>
              <h2>Resources</h2>
              <ul>
                  <li><a href="https://github.com/${{ github.repository }}">Source Repository</a></li>
                  <li><a href="https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG}">Latest Release</a></li>
              </ul>
          </body>
          </html>
          EOF

      - name: Try to checkout gh-pages branch
        id: checkout_gh_pages
        continue-on-error: true
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            git checkout gh-pages
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup gh-pages directory
        run: |
          if [ "${{ steps.checkout_gh_pages.outputs.exists }}" = "true" ]; then
            echo "Updating existing gh-pages branch"
            # Keep .git directory, remove everything else
            find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'pypi-repo' -exec rm -rf {} +
          else
            echo "Creating new gh-pages branch"
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
          fi

          # Copy PyPI repository contents to root
          cp -r pypi-repo/* .
          rm -rf pypi-repo

          # Create .nojekyll to disable Jekyll processing
          touch .nojekyll

          echo "âœ… gh-pages directory prepared"
          ls -la

      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "Publish PyPI repository - $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          Build configuration:
          - ROCm: ${{ github.event.inputs.rocm_version }}
          - Python: ${{ github.event.inputs.python_version }}
          - GPU Arch: ${{ github.event.inputs.pytorch_rocm_arch }}
          - Commit: ${{ github.sha }}
          - Release: ${{ steps.separate_wheels.outputs.release_tag }}" || echo "No changes to commit"

          git push origin gh-pages --force

          echo "âœ… PyPI repository published to GitHub Pages"

      - name: Summary
        run: |
          PAGES_URL="https://${{ github.repository_owner }}.github.io/vllm-rocm"
          RELEASE_TAG="${{ steps.separate_wheels.outputs.release_tag }}"
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… PyPI repository published successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Command" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install vllm-rocm --index-url ${PAGES_URL}/simple/" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- ROCm Version: ${{ github.event.inputs.rocm_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Version: ${{ github.event.inputs.python_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- GPU Architectures: ${{ github.event.inputs.pytorch_rocm_arch }}" >> $GITHUB_STEP_SUMMARY
          echo "- Total Wheels: $(find . -name "*.whl" 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Storage Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- Small wheels (&lt;100MB): GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "- Large wheels (&gt;100MB): GitHub Releases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository Home**: ${PAGES_URL}/" >> $GITHUB_STEP_SUMMARY
          echo "- **PyPI Index**: ${PAGES_URL}/simple/" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG}" >> $GITHUB_STEP_SUMMARY